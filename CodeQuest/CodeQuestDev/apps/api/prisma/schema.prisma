// CodeQuest - Prisma Schema
// Database: PostgreSQL (Neon.tech)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Users & Authentication
// ========================================

model User {
  id          String   @id @default(cuid())
  googleId    String   @unique @map("google_id")
  email       String   @unique
  name        String
  avatarUrl   String?  @map("avatar_url")
  xp          Int      @default(0)
  level       Int      @default(1)
  locale      String   @default("pt-BR")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  progress          Progress[]
  badges            UserBadge[]
  streak            Streak?
  flashcards        Flashcard[]
  sentChallenges    Challenge[]  @relation("Challenger")
  receivedChallenges Challenge[] @relation("Challenged")
  friendships       Friendship[] @relation("User")
  friendOf          Friendship[] @relation("Friend")

  @@map("users")
}

model Streak {
  userId           String   @id @map("user_id")
  currentStreak    Int      @default(0) @map("current_streak")
  longestStreak    Int      @default(0) @map("longest_streak")
  lastActivityDate DateTime @map("last_activity_date") @db.Date

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streaks")
}

// ========================================
// Content: Tracks, Lessons, Questions
// ========================================

model Track {
  id        String   @id @default(cuid())
  slug      String   @unique
  titlePtBr String   @map("title_pt_br")
  titleEn   String   @map("title_en")
  icon      String
  order     Int
  createdAt DateTime @default(now()) @map("created_at")

  lessons Lesson[]

  @@map("tracks")
}

model Lesson {
  id          String   @id @default(cuid())
  trackId     String   @map("track_id")
  slug        String   @unique
  titlePtBr   String   @map("title_pt_br")
  titleEn     String   @map("title_en")
  contentPtBr String   @map("content_pt_br") @db.Text
  contentEn   String   @map("content_en") @db.Text
  order       Int
  xpReward    Int      @default(100) @map("xp_reward")
  createdAt   DateTime @default(now()) @map("created_at")

  track     Track      @relation(fields: [trackId], references: [id], onDelete: Cascade)
  questions Question[]
  progress  Progress[]
  challenges Challenge[]

  @@map("lessons")
}

model Question {
  id              String   @id @default(cuid())
  lessonId        String   @map("lesson_id")
  type            String   // "multiple_choice", "true_false", "fill", "code"
  questionPtBr    String   @map("question_pt_br") @db.Text
  questionEn      String   @map("question_en") @db.Text
  optionsPtBr     Json?    @map("options_pt_br")
  optionsEn       Json?    @map("options_en")
  answer          Json     // Can be string, boolean, or array
  acceptedAnswers Json?    @map("accepted_answers")
  explanationPtBr String?  @map("explanation_pt_br") @db.Text
  explanationEn   String?  @map("explanation_en") @db.Text
  difficulty      Int      @default(1) // 1-5
  createdAt       DateTime @default(now()) @map("created_at")

  lesson     Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  flashcards Flashcard[]

  @@map("questions")
}

// ========================================
// Progress & Gamification
// ======================================== 

model Progress {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  lessonId    String    @map("lesson_id")
  score       Int       @default(0)
  totalQuestions Int    @default(0) @map("total_questions")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("progress")
}

model Badge {
  id              String   @id @default(cuid())
  slug            String   @unique
  namePtBr        String   @map("name_pt_br")
  nameEn          String   @map("name_en")
  descriptionPtBr String   @map("description_pt_br")
  descriptionEn   String   @map("description_en")
  icon            String
  category        String   // "completion", "streak", "performance", "social"
  requirement     Json     // Criteria for earning
  xpBonus         Int      @default(0) @map("xp_bonus")
  createdAt       DateTime @default(now()) @map("created_at")

  users UserBadge[]

  @@map("badges")
}

model UserBadge {
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@map("user_badges")
}

// ========================================
// Flashcards (Spaced Repetition)
// ========================================

model Flashcard {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  questionId  String   @map("question_id")
  easeFactor  Float    @default(2.5) @map("ease_factor")
  interval    Int      @default(1) // Days
  repetitions Int      @default(0)
  nextReview  DateTime @default(now()) @map("next_review") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@map("flashcards")
}

// ========================================
// Social: Friendships & Challenges
// ========================================

model Friendship {
  userId    String   @map("user_id")
  friendId  String   @map("friend_id")
  status    String   @default("pending") // "pending", "accepted", "blocked"
  createdAt DateTime @default(now()) @map("created_at")

  user   User @relation("User", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("Friend", fields: [friendId], references: [id], onDelete: Cascade)

  @@id([userId, friendId])
  @@map("friendships")
}

model Challenge {
  id               String    @id @default(cuid())
  challengerId     String    @map("challenger_id")
  challengedId     String    @map("challenged_id")
  lessonId         String    @map("lesson_id")
  status           String    @default("pending") // "pending", "in_progress", "completed", "expired"
  isRealtime       Boolean   @default(false) @map("is_realtime")
  challengerAnswers Json?    @map("challenger_answers")
  challengedAnswers Json?    @map("challenged_answers")
  challengerScore  Int?      @map("challenger_score")
  challengedScore  Int?      @map("challenged_score")
  winnerId         String?   @map("winner_id")
  expiresAt        DateTime  @map("expires_at")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  challenger User   @relation("Challenger", fields: [challengerId], references: [id], onDelete: Cascade)
  challenged User   @relation("Challenged", fields: [challengedId], references: [id], onDelete: Cascade)
  lesson     Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("challenges")
}
